<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style>
		h2 {
			text-align: center;
		}
		body {
			background-color: #cccccc;
		}
		canvas {
			background-color: #ffffff;
		}
		textarea {
		  resize: none;
		  width:500px;
		  height:100px;
		}
	</style>
</head>
<body>
<section>
	<h2>QRcode生成javascript</h2>
	<input type=button id="st" value="set" onclick="main();">

<select id="mask_ptn">
<option value="000">000</option>
<option value="001">001</option>
<option value="010">010</option>
<option value="011">011</option>
<option value="100">100</option>
<option value="101">101</option>
<option value="110">110</option>
<option value="111">111</option>
</select>

<select id="rensetsu">
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
<option value="13">13</option>
<option value="14">14</option>
<option value="15">15</option>
<option value="16">16</option>
</select>
	<textarea id="moji">　吾輩は猫である。名前はまだ無い。
　どこで生れたかとんと見当がつかぬ。何でも薄暗いじめじめした所でニャーニャー泣いていた事だけは記憶している。吾輩はここで始めて人間というものを見た。しかもあとで聞くとそれは書生という人間中で一番獰悪な種族であったそうだ。この書生というのは時々我々を捕えて煮て食うという話である。しかしその当時は何という考もなかったから別段恐しいとも思わなかった。ただ彼の掌に載せられてスーと持ち上げられた時何だかフワフワした感じがあったばかりである。</textarea>
<p>1: <canvas id="canv1" width="800" height="60"></canvas></p>
<p>2: <canvas id="canv2" width="800" height="60"></canvas></p>
<p>3: <canvas id="canv3" width="800" height="60"></canvas></p>
<p>4: <canvas id="canv4" width="800" height="60"></canvas></p>
<p>5: <canvas id="canv5" width="800" height="60"></canvas></p>
<p>6: <canvas id="canv6" width="800" height="60"></canvas></p>
<p>7: <canvas id="canv7" width="800" height="60"></canvas></p>
<p>8: <canvas id="canv8" width="800" height="60"></canvas></p>
<p>9: <canvas id="canv9" width="800" height="60"></canvas></p>
<p>10: <canvas id="canv10" width="800" height="60"></canvas></p>
<p>11: <canvas id="canv11" width="800" height="60"></canvas></p>
<p>12: <canvas id="canv12" width="800" height="60"></canvas></p>
<p>13: <canvas id="canv13" width="800" height="60"></canvas></p>
<p>14: <canvas id="canv14" width="800" height="60"></canvas></p>
<p>15: <canvas id="canv15" width="800" height="60"></canvas></p>
<p>16: <canvas id="canv16" width="800" height="60"></canvas></p>
</section>

<script>

function b16(n){return ('0000000000000000' + n.toString(2)).slice(-16)}
function b8(n) {return ('00000000' + n.toString(2)).slice(-8)}
function b4(n) {return ('0000' + n.toString(2)).slice(-4)}
function b2(n) {return ('00' + n.toString(2)).slice(-2)}


function get_xor(s1,s2){
	rt = '';
	//alert(s1 + "_"+ s2)
	for(var s=0;s<s1.length;s++){
		v = (s1.substr(s,1)) ^ (s2.substr(s,1));
		//alert("aaa" + s1.substr(s,1) + "_" + (s2.substr(s,1)) +"_" + v);
		rt = rt + '' + v;
	}
	return rt;
}

function mask_ptn_hantei(mask,i,j){

	var flg = false;

	switch (mask){
	case '000':
		if(  (j+i) % 2 == 0  ){ flg = true; } else { flg = false;}
		break;
	case '001':
		if(  j % 2 == 0  ){ flg = true; } else { flg = false;}
		break;
	case '010':
		if(  i % 3 == 0  ){ flg = true; } else { flg = false;}
		break;
	case '011':
		if(  (j+i) % 3 == 0  ){ flg = true; } else { flg = false;}
		break;
	case '100':
		if(  (Math.floor(j/2)+Math.floor(i/3)) % 2 == 0  ){ flg = true; } else { flg = false;}
		break;
	case '101':
		if(  ((j*i) % 2 + (j*i) % 3) == 0  ){ flg = true; } else { flg = false;}
		break;
	case '110':
		if(  ((j*i) % 2 + (j*i) % 3) % 2 == 0  ){ flg = true; } else { flg = false;}
		break;
	case '111':
		if(  ((j*i) % 3 + (j+i) % 2) % 2 == 0  ){ flg = true; } else { flg = false;}
		break;
	default:
		break;
	}
	
	return flg;

		//規格では、横方向がjで、縦方向がiだが
		//このソースでは横方向がiで、縦方向がj（スマン
		/* マスク計算方法
		000 → (j+i) % 2 == 0
		001 → j % 2 == 0
		010 → i % 3 == 0
		011 → (j+i) % 3 == 0
		100 → ((j / 2)+(i / 3)) % 2 == 0
		101 → ((j*i) % 2 + (j*i) % 3) == 0
		110 → ((j*i) % 2 + (j*i) % 3) % 2 == 0
		111 → ((j*i) % 3 + (j+i) % 2) % 2 == 0
		*/

		//規格では、横方向がj(列位置)で、縦方向がi(行位置)
		/* マスク計算方法(規格としての記載)
		000 → (i+j) mod 2 = 0
		001 → i mod 2 = 0
		010 → j mod 3 = 0
		011 → (i+j) mod 3 = 0
		100 → (( i div 2)+(j div 3)) mod 2 = 0
		101 → (ij) mod 2 + (ij) mod 3 = 0
		110 → ((ij) mod 2 +(ij) mod 3) mod 2 = 0
		111 → ((ij)mod 3 + (i+j) mod 2) mod 2 = 0
		*/
		//----------------------------------
}



function RSCoding(d1,c1,c2){//1
var gr= [];
	gr[7]=[21,102,238,149,146,229,87,0];
	gr[10]=[45,32,94,64,70,118,61,46,67,251,0];
	gr[13]=[78,140,206,218,130,104,106,100,86,100,176,152,74,0];
	gr[15]=[105,99,5,124,140,237,58,58,51,37,202,91,61,183,8,0];
	gr[16]=[120,225,194,182,169,147,191,91,3,76,161,102,109,107,104,120,0];
	gr[17]=[136,163,243,39,150,99,24,147,214,206,123,239,43,78,206,139,43,0];
	gr[18]=[153,96,98,5,179,252,148,152,187,79,170,118,97,184,94,158,234,215,0];
	gr[20]=[190,188,212,212,164,156,239,83,225,221,180,202,187,26,163,61,50,79,60,17,0];
	gr[22]=[231,165,105,160,134,219,80,98,172,8,74,200,53,221,109,14,230,93,242,247,171,210,0];
	gr[24]=[21,227,96,87,232,117,0,111,218,228,226,192,152,169,180,159,126,251,117,211,48,135,121,229,0];
	gr[26]=[70,218,145,153,227,48,102,13,142,245,21,161,53,165,28,111,201,145,17,118,182,103,2,158,125,173,0];
	gr[28]=[123,9,37,242,119,212,195,42,87,245,43,21,201,232,27,205,147,195,190,110,180,108,234,224,104,200,223,168,0];
	gr[30]=[180,192,40,238,216,251,37,156,130,224,193,226,173,42,125,222,96,239,86,110,48,50,182,179,31,216,152,145,173,41,0];
	gr[32]=[241,220,185,254,52,80,222,28,60,171,60,38,156,80,185,120,27,89,123,242,32,138,138,209,67,4,167,249,190,106,6,10,0];
	gr[34]=[51,129,62,98,13,167,129,183,61,114,70,56,103,218,239,229,158,58,125,163,140,86,193,113,94,105,19,108,21,26,94,146,77,111,0];
	gr[36]=[120,30,233,113,251,117,196,121,74,120,177,105,210,87,37,218,63,18,107,238,248,113,152,167,0,115,152,60,234,246,31,172,16,98,183,200,0];
	gr[40]=[15,35,53,232,20,72,134,125,163,47,41,88,114,181,35,175,7,170,104,226,174,187,26,53,106,235,56,163,57,247,161,128,205,128,98,252,161,79,116,59,0];
	gr[42]=[96,50,117,194,162,171,123,201,254,237,199,213,101,39,223,101,34,139,131,15,147,96,106,188,8,230,84,110,191,221,242,58,3,0,231,137,18,25,230,221,103,250,0];
	gr[44]=[181,73,102,113,130,37,169,204,147,217,194,52,163,68,114,118,126,224,62,143,78,44,238,1,247,14,145,9,123,72,25,191,243,89,188,168,55,69,246,71,121,61,7,190,0];
	gr[46]=[15,82,19,223,202,43,224,157,25,52,174,119,245,249,8,234,104,73,241,60,96,4,1,36,211,169,216,135,16,58,44,129,113,54,5,89,99,187,115,202,224,253,112,88,94,112,0];
	gr[48]=[108,34,39,163,50,84,227,94,11,191,238,140,156,247,21,91,184,120,150,95,206,107,205,182,160,135,111,221,18,115,123,46,63,178,61,240,102,39,90,251,24,60,146,211,130,196,25,228,0];
	gr[50]=[205,133,232,215,170,124,175,235,114,228,69,124,65,113,32,189,42,77,75,242,215,242,160,130,209,126,160,32,13,46,225,203,242,195,111,209,3,35,193,203,99,209,46,118,9,164,161,157,125,232,0];
	gr[52]=[51,116,254,239,33,101,220,200,242,39,97,86,76,22,121,235,233,100,113,124,65,59,94,190,89,254,134,203,242,37,145,59,14,22,215,151,233,184,19,124,127,86,46,192,89,251,220,50,186,86,50,116,0];
	gr[54]=[156,31,76,198,31,101,59,153,8,235,201,128,80,215,108,120,43,122,25,123,79,172,175,238,254,35,245,52,192,184,95,26,165,109,218,209,58,102,225,249,184,238,50,45,65,46,21,113,221,210,87,201,26,183,0];
	gr[56]=[10,61,20,207,202,154,151,247,196,27,61,163,23,96,206,152,124,101,184,239,85,10,28,190,174,177,249,182,142,127,139,12,209,170,208,135,155,254,144,6,229,202,201,36,163,248,91,2,116,112,216,164,157,107,120,106,0];
	gr[58]=[123,148,125,233,142,159,63,41,29,117,245,206,134,127,145,29,218,129,6,214,240,122,30,24,23,125,165,65,142,253,85,206,249,152,248,192,141,176,237,154,144,210,242,251,55,235,185,200,182,252,107,62,27,66,247,26,116,82,0];
	gr[60]=[240,33,7,89,16,209,27,70,220,190,102,65,87,194,25,84,181,30,124,11,86,121,209,160,49,238,38,37,82,160,109,101,219,115,57,198,205,2,247,100,6,127,181,28,120,219,101,211,45,219,197,226,197,243,141,9,12,26,140,107,0];
	gr[62]=[106,110,186,36,215,127,218,182,246,26,100,200,6,115,40,213,123,147,149,229,11,235,117,221,35,181,126,212,17,194,111,70,50,72,89,223,76,70,118,243,78,135,105,7,121,58,228,2,23,37,122,0,94,214,118,248,223,71,98,113,202,65,0];
	gr[64]=[231,213,156,217,243,178,11,204,31,242,230,140,108,99,63,238,242,125,195,195,140,47,146,184,47,91,216,4,209,218,150,208,156,145,24,29,212,199,93,160,53,127,26,119,149,141,78,200,254,187,204,177,123,92,119,68,49,159,158,7,9,175,51,45,0];
	gr[66]=[105,45,93,132,25,171,106,67,146,76,82,168,50,106,232,34,77,217,126,240,253,80,87,63,143,121,40,236,111,77,154,44,7,95,197,169,214,72,41,101,95,111,68,178,137,65,173,95,171,197,247,139,17,81,215,13,117,46,51,162,136,136,180,222,118,5,0];
	gr[68]=[238,163,8,5,3,127,184,101,27,235,238,43,198,175,215,82,32,54,2,118,225,166,241,137,125,41,177,52,231,95,97,199,52,227,89,160,173,253,84,15,84,93,151,203,220,165,202,60,52,133,205,190,101,84,150,43,254,32,160,90,70,77,93,224,33,223,159,247,0];
//Int2ExpTbl
var i2e=[
	-1,0,1,25,2,50,26,198,3,223,51,238,27,104,199,75,4,100,224,14,52,141,
	239,129,28,193,105,248,200,8,76,113,5,138,101,47,225,36,15,33,53,
	147,142,218,240,18,130,69,29,181,194,125,106,39,249,185,201,154,9,120,
	77,228,114,166,6,191,139,98,102,221,48,253,226,152,37,179,16,145,34,136,
	54,208,148,206,143,150,219,189,241,210,19,92,131,56,70,64,30,66,182,163,
	195,72,126,110,107,58,40,84,250,133,186,61,202,94,155,159,10,21,121,43,
	78,212,229,172,115,243,167,87,7,112,192,247,140,128,99,13,103,74,222,237,
	49,197,254,24,227,165,153,119,38,184,180,124,17,68,146,217,35,32,137,
	46,55,63,209,91,149,188,207,205,144,135,151,178,220,252,190,97,242,86,
	211,171,20,42,93,158,132,60,57,83,71,109,65,162,31,45,67,216,183,123,164,
	118,196,23,73,236,127,12,111,246,108,161,59,82,41,157,85,170,251,96,134,
	177,187,204,62,90,203,89,95,176,156,169,160,81,11,245,22,235,122,117,
	44,215,79,174,213,233,230,231,173,232,116,214,244,234,168,80,88,175];
//Exp2IntTbl
var e2i=[
	1,2,4,8,16,32,64,128,29,58,116,232,205,135,19,38,76,152,45,90,180,117,
	234,201,143,3,6,12,24,48,96,192,157,39,78,156,37,74,148,53,106,212,181,
	119,238,193,159,35,70,140,5,10,20,40,80,160,93,186,105,210,185,111,222,161,
	95,190,97,194,153,47,94,188,101,202,137,15,30,60,120,240,253,231,211,187,
	107,214,177,127,254,225,223,163,91,182,113,226,217,175,67,134,17,34,68,136,
	13,26,52,104,208,189,103,206,129,31,62,124,248,237,199,147,59,118,236,197,
	151,51,102,204,133,23,46,92,184,109,218,169,79,158,33,66,132,21,42,84,168,
	77,154,41,82,164,85,170,73,146,57,114,228,213,183,115,230,209,191,99,198,
	145,63,126,252,229,215,179,123,246,241,255,227,219,171,75,150,49,98,196,149,
	55,110,220,165,87,174,65,130,25,50,100,200,141,7,14,28,56,112,224,221,167,
	83,166,81,162,89,178,121,242,249,239,195,155,43,86,172,69,138,9,18,36,72,144,
	61,122,244,245,247,243,251,235,203,139,11,22,44,88,176,125,250,233,207,131,27,
	54,108,216,173,71,142,1];
	for(var p=0;p<=(c1-c2);p++){//2
		t1 = i2e[d1[c1-p]];
		if(t1<0){//3
			t3 = 0;
		}else{
			t2 = e2i[t1];
			t3 = d1[c1-p]^t2;
		}//3
		d1[c1-p] = t3;
		for(var q=1;q<=c2;q++){//4
			if(t1<0){//5
			}else{
			t1a = t1 + gr[c2][c2-q];
				if(t1a>255){t1a-=255;}
			t2a = e2i[t1a];
			t3a = d1[c1-p-q]^t2a;
			d1[c1-p-q] = t3a;
			}//5
		}//4
	}//2
return d1;
}//1

/////////------------------------------/////////

function main(){


//mask_ptn マスクパターン
var mask_ptn = document.getElementById('mask_ptn').value;
//alert(mask_ptn);

//rnst rensetsu 連接
var rnst = document.getElementById('rensetsu').value;
//alert(rnst);

var rd = 3; //１モジュール（１マスあたりのサイズ）
var mgn = 0;

////エンコードする文字の取得
var str1 = document.getElementById('moji').value;


////----文字の二進化----////
var bytcnt_orig = 0; //バイト数の計測
var btstring_orig = "";
var bst_xor = 0;

for(var s=0;s<str1.length;s++){
	if(str1.charCodeAt(s)<=127){
		bst_xor = bst_xor ^ (str1.charCodeAt(s));
		btstring_orig += b8(str1.charCodeAt(s));
		//var t = str1.charCodeAt(s).toString(16);
		bytcnt_orig ++;
	}else{
		var t = encodeURI(str1.substr(s,1)).split('%');
		t.shift();//
		for(var u=0;u<t.length;u++){
			bst_xor = bst_xor ^ (parseInt(t[u],16));
			btstring_orig += b8(parseInt(t[u],16));
			bytcnt_orig ++;
		}
	}
}
//alert(bytcnt_orig);

var bytcnt_splt;
bytcnt_splt = Math.ceil(bytcnt_orig / rnst);
//alert(bytcnt_splt);

//alert(btstring_orig.length);

var btstring = [];
var bytcnt = [];
for(var j=0; j<rnst; j++){
	btstring[j] = "";
}

var cj = 0;
bytcnt_orig = 0;

for(var s=0;s<str1.length;s++){
	if(str1.charCodeAt(s)<=127){
		cj = Math.floor(bytcnt_orig / bytcnt_splt);
		btstring[cj] += b8(str1.charCodeAt(s));
		bytcnt_orig ++;
	}else{
		cj = Math.floor(bytcnt_orig / bytcnt_splt);
		var t = encodeURI(str1.substr(s,1)).split('%');
		t.shift();//
		for(var u=0;u<t.length;u++){
			btstring[cj] += b8(parseInt(t[u],16));
			bytcnt_orig ++;
		}
	}
}
//alert("a: "+ bytcnt_orig);

for(var j=0; j<rnst; j++){
	bytcnt[j] = btstring[j].length/8;
	//alert( j +"_" + btstring[j].length/8 +"_" + bytcnt[j] );
}

//////////////■型番
var settei = [];
//型番,表１=１辺(ﾓｼﾞｭｰﾙ数)
//,表E:位置合わせﾊﾟﾀｰﾝ,表７:データ数-Lv=Q(byte)
settei[1]  = [21,[6+1],13];
settei[2]  = [25,[6+1,18+1],22];
settei[3]  = [29,[6+1,22+1],34];
settei[4]  = [33,[6+1,26+1],48];
settei[5]  = [37,[6+1,30+1],62];
settei[6]  = [41,[6+1,34+1],76];
settei[7]  = [45,[6+1,22+1,38+1],88];
settei[8]  = [49,[6+1,24+1,42+1],110];
settei[9]  = [53,[6+1,26+1,46+1],132];
settei[10] = [57,[6+1,28+1,50+1],154];
settei[11] = [61,[6+1,30+1,54+1],180];
settei[12] = [65,[6+1,32+1,58+1],206];
settei[13] = [69,[6+1,34+1,62+1],244];
settei[14] = [73,[6+1,26+1,46+1,66+1],261];
settei[15] = [77,[6+1,26+1,48+1,70+1],295];
settei[16] = [81,[6+1,26+1,50+1,74+1],325];
settei[17] = [85,[6+1,30+1,54+1,78+1],367];
settei[18] = [89,[6+1,30+1,56+1,82+1],397];
settei[19] = [93,[6+1,30+1,58+1,86+1],445];
settei[20] = [97,[6+1,34+1,62+1,90+1],485];
settei[21] = [101,[6+1,28+1,50+1,72+1,94+1],512];
settei[22] = [105,[6+1,26+1,50+1,74+1,98+1],568];
settei[23] = [109,[6+1,30+1,54+1,78+1,102+1],614];
settei[24] = [113,[6+1,28+1,54+1,80+1,106+1],664];
settei[25] = [117,[6+1,32+1,58+1,84+1,110+1],718];
settei[25] = [117,[6+1,32+1,58+1,84+1,110+1],718];
settei[26] = [121,[6+1,30+1,58+1,86+1,114+1],754];
settei[27] = [125,[6+1,34+1,62+1,90+1,118+1],808];
settei[28] = [129,[6+1,26+1,50+1,74+1,98+1,122+1],871];
settei[29] = [133,[6+1,30+1,54+1,78+1,102+1,126+1],911];
settei[30] = [137,[6+1,26+1,52+1,78+1,104+1,130+1],985];
settei[31] = [141,[6+1,30+1,56+1,82+1,108+1,134+1],1033];
settei[32] = [145,[6+1,34+1,60+1,86+1,112+1,138+1],1115];
settei[33] = [149,[6+1,30+1,58+1,86+1,114+1,142+1],1171];
settei[34] = [153,[6+1,34+1,62+1,90+1,118+1,146+1],1231];
settei[35] = [157,[6+1,30+1,54+1,78+1,102+1,126+1,150+1],1286];
settei[36] = [161,[6+1,24+1,50+1,76+1,102+1,128+1,154+1],1354];
settei[37] = [165,[6+1,28+1,54+1,80+1,106+1,132+1,158+1],1426];
settei[38] = [169,[6+1,32+1,58+1,84+1,110+1,136+1,162+1],1502];
settei[39] = [173,[6+1,26+1,54+1,82+1,110+1,138+1,166+1],1582];
settei[40] = [177,[6+1,30+1,58+1,86+1,114+1,142+1,170+1],1666];
const SAIDAI = 40;
for(var s=1;s<=SAIDAI;s++){
	var ss=0;
	if(s>=9){ss=1}//型９以上はバイト数情報が2byte
	//"-2"byteは　モード指示（8bit-byte)+byte数+終端
	//if(bytcnt<=settei[s][2]-2-ss){

	// -3 は、構造的連接の2.5byte分用
	// +10 は、バッファ
	if(bytcnt_splt + 10 <=settei[s][2]-2-ss -3){
		break;
	}
}
if(s>SAIDAI){
	alert("文字数オーバー");
	return;
}
const KTB = s; 
//alert("型番: " + KTB );

////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////

//キャンバスの整理
//var cs  = document.getElementById('canv1');
//var ctx = cs.getContext('2d');
//ctx.clearRect(0, 0, cs.width, cs.height);
var ctx = [];

//全キャンバスのクリア
for(var c=0; c<16; c++){
	var cs  = document.getElementById('canv' + (c+1));
	ctx[c] = cs.getContext('2d');
	ctx[c].clearRect(0, 0, cs.width, cs.height);
}

////rnst c
for(var c=0; c<rnst; c++){
	//alert('canv' + (c+1));
	var cs  = document.getElementById('canv' + (c+1));
	ctx[c] = cs.getContext('2d');
	ctx[c].clearRect(0, 0, cs.width, cs.height);


//////////////配列準備
var arr1 = [];
var arr_notdata = [];
var arr_data = [];
const SZ = settei[KTB][0]; //１辺(ﾓｼﾞｭｰﾙ数)
var arr_ichi = settei[KTB][1]; //位置合わせ

	cs.height = 30+30+SZ*3; //キャンバスの高さ調整

//表９
var tnk =[]; //総データ数,ブロック数自体の個数,
//１つ目のブロックのバイト,データのバイト,１つ目のブロック数,
//２つ目のブロックのバイト,データのバイト,２つ目のブロック数（もしあれば）
tnk[1]  = [13,1,26,13,1]; //1
tnk[2]  = [22,1,44,22,1]; //2
tnk[3]  = [34,1,35,17,2]; //3
tnk[4]  = [48,1,50,24,2]; //4
tnk[5]  = [62,2,33,15,2,34,16,2]; //5
tnk[6]  = [76,1,43,19,4]; //6
tnk[7]  = [88,2,32,14,2,33,15,4]; //7
tnk[8]  = [110,2,40,18,4,41,19,2]; //8
tnk[9]  = [132,2,36,16,4,37,17,4]; //9
tnk[10] = [154,2,43,19,6,44,20,2]; //10
tnk[11] = [180,2,50,22,4,51,23,4];
tnk[12] = [206,2,46,20,4,47,21,6];
tnk[13] = [244,2,44,20,8,45,21,4];
tnk[14] = [261,2,36,16,11,37,17,5];
tnk[15] = [295,2,54,24,5,55,25,7]; //15
tnk[16] = [325,2,43,19,15,44,20,2];
tnk[17] = [367,2,50,22,1,51,23,15];
tnk[18] = [397,2,50,22,17,51,23,1];
tnk[19] = [445,2,47,21,17,48,22,4];
tnk[20] = [485,2,54,24,15,55,25,5]; //20
tnk[21] = [512,2,50,22,17,51,23,6];
tnk[22] = [568,2,54,24,7,55,25,16];
tnk[23] = [614,2,54,24,11,55,25,14];
tnk[24] = [664,2,54,24,11,55,25,16];
tnk[25] = [718,2,54,24,7,55,25,22]; //25
tnk[26] = [754,2,50,22,28,51,23,6];
tnk[27] = [808,2,53,23,8,54,24,26];
tnk[28] = [871,2,54,24,4,55,25,31];
tnk[29] = [911,2,53,23,1,54,24,37];
tnk[30] = [985,2,54,24,15,55,25,25];
tnk[31] = [1033,2,54,24,42,55,25,1];
tnk[32] = [1115,2,54,24,10,55,25,35];
tnk[33] = [1171,2,54,24,29,55,25,19];
tnk[34] = [1231,2,54,24,44,55,25,7];
tnk[35] = [1286,2,54,24,39,55,25,19];
tnk[36] = [1354,2,54,24,46,55,25,10];
tnk[37] = [1426,2,54,24,49,55,25,10];
tnk[38] = [1502,2,54,24,48,55,25,14];
tnk[39] = [1582,2,54,24,43,55,25,22];
tnk[40] = [1666,2,54,24,34,55,25,34];

const DataSZ = settei[KTB][2]; //データ数
//配列の初期化
for(var j=0; j<SZ; j++){
	arr1[j] = [];
	arr_notdata[j] = [];
	arr_data[j] = [];
	for(var i=0; i<SZ; i++){
		arr1[j][i] = 0;
		arr_notdata[j][i] = 0;
		arr_data[j][i] = 0;
	}
}
//JIS X0510 7.4 表３　→型番10[154byte]以上が、16bit。以下[132byte]が8bit

//JIS X0510 「8 構造的連接」
//例）"0011"+"0000"+"0001"+"00010110"
// 0011;　構造的連接
// n番目
// 全m枚
// 全データのXORのパリティ

//rnstbit = "0011"+"0000"+"0001"+"00010110";
//bst_xor =0;
rnstbit = "0011"+b4(c)+b4(rnst-1)+b8(bst_xor);
//alert(rnstbit);

//alert(c +"_"+ bytcnt[c] + "_"+btstring[c]);

//rnstbit = "";

if(KTB<=9){//型番9まで
btstring[c] = rnstbit + "0100" + b8(bytcnt[c]) + btstring[c];  // 8bit byte mode + byte数
}else{//型番10以上は、byte数を16bitに
btstring[c] = rnstbit + "0100" + b16(bytcnt[c]) + btstring[c];  // 8bit byte mode + byte数
}
btstring[c] += "0000"; //終端パターン
//btstring += ("11101100" + "00010001").repeat(DataSZ); //repeatはIE不可
for(var q=0;q<DataSZ;q++){
	btstring[c] += ("11101100" + "00010001");
}
//１０進での格納
var arr_btst = [];
for(ab=0;ab<DataSZ;ab+=1){
	arr_btst[ab] = btstring[c].substr(ab*8,8);
}
//JIS X0510 表D.1
var ktjh=[];
ktjh[7] = "07C94";//7
ktjh[8] = "085BC";//8
ktjh[9] = "09A99";//9
ktjh[10] = "0A4D3";//10
ktjh[11] = "0BBF6";//11
ktjh[12] = "0C762";//12
ktjh[13] = "0D847";//13
ktjh[14] = "0E60D";//14
ktjh[15] = "0F928";//15
ktjh[16] = "10B78";//16
ktjh[17] = "1145D";//17
ktjh[18] = "12A17";//18
ktjh[19] = "13532";//19
ktjh[20] = "149A6";//20
ktjh[21] = "15683";//21
ktjh[22] = "168C9";//22
ktjh[23] = "177EC";//23
ktjh[24] = "18EC4";//24
ktjh[25] = "191E1";//25
ktjh[26] = "1AFAB";//26
ktjh[27] = "1B08E";//27
ktjh[28] = "1CC1A";//28
ktjh[29] = "1D33F";//29
ktjh[30] = "1ED75";//30
ktjh[31] = "1F250";//31
ktjh[32] = "209D5";//32
ktjh[33] = "216F0";//33
ktjh[34] = "228BA";//34
ktjh[35] = "2379F";//35
ktjh[36] = "24B0B";//36
ktjh[37] = "2542E";//37
ktjh[38] = "26A64";//38
ktjh[39] = "27541";//39
ktjh[40] = "28C69";//40
if(KTB>=7){
	kt = [];
	kt[0] = b2(parseInt(ktjh[KTB].substr(0,1),16));
	kt[1] = b4(parseInt(ktjh[KTB].substr(1,1),16));
	kt[2] = b4(parseInt(ktjh[KTB].substr(2,1),16));
	kt[3] = b4(parseInt(ktjh[KTB].substr(3,1),16));
	kt[4] = b4(parseInt(ktjh[KTB].substr(4,1),16));
	ktbmx = "";
	for(k=0;k<5;k++){
		ktbmx += kt[k];
	}
}
//*1
var arr_d = [];
arr_cn=0;
for(s=0;s<tnk[KTB][4];s++){
	arr_d[arr_cn] = [];arr_cn++;
}
if(tnk[KTB][1]>1){
	for(s=0;s<tnk[KTB][7];s++){
		arr_d[arr_cn] = [];arr_cn++;
	}
}
//*2
for(s=0;s<arr_d.length;s++){
	for(var d=0;d<tnk[KTB][2]-tnk[KTB][3];d++){
		arr_d[s][d]=0;
	}
}
//*3
var pst;
s=0;
pst =(tnk[KTB][2]-1);
arr_cn=0;
for(s=0;s<tnk[KTB][4];s++){
	for(var d=(tnk[KTB][2]-1);d>(tnk[KTB][2]-tnk[KTB][3]-1);d--){
		arr_d[arr_cn][d] = parseInt(arr_btst[pst-d],2);
	}
	pst +=tnk[KTB][3];
	arr_cn++;
}
if(tnk[KTB][1]>1){
	pst =(tnk[KTB][5]-1);
	for(s=0;s<tnk[KTB][4];s++){
		pst +=tnk[KTB][3];
	}
	for(s=0;s<tnk[KTB][7];s++){
		for(var d=(tnk[KTB][5]-1);d>(tnk[KTB][5]-tnk[KTB][6]-1);d--){
			arr_d[arr_cn][d] = parseInt(arr_btst[pst-d],2);
		}
		pst +=tnk[KTB][6];
		arr_cn++;
	}
}
//*4
var arr_drt = [];
arr_cn=0;
for(s=0;s<tnk[KTB][4];s++){
	arr_drt[arr_cn] = arr_d[arr_cn].slice();
	RSCoding(arr_drt[arr_cn],tnk[KTB][2],tnk[KTB][2]-tnk[KTB][3]);
	arr_cn++;
}
if(tnk[KTB][1]>1){
	for(s=0;s<tnk[KTB][7];s++){
		arr_drt[arr_cn] = arr_d[arr_cn].slice();
		RSCoding(arr_drt[arr_cn],tnk[KTB][5],tnk[KTB][5]-tnk[KTB][6]);
		arr_cn++;
	}
}
//*5
////データ＋誤り訂正を、１列に並べる
var arr_dtout;
arr_dtout = [];
cn=0;
for(var d=(tnk[KTB][2]-1);d>(tnk[KTB][2]-tnk[KTB][3]-1);d--){
	arr_cn=0;
	for(s=0;s<tnk[KTB][4];s++){
		arr_dtout[cn]=arr_d[arr_cn][d];cn++;arr_cn++;
	}
	if(tnk[KTB][1]>1){
		for(s=0;s<tnk[KTB][7];s++){
			arr_dtout[cn]=arr_d[arr_cn][d+1];cn++;arr_cn++;
		}
	}
}
	arr_cn=0;
	for(s=0;s<tnk[KTB][4];s++){
		arr_cn++;
	}
	if(tnk[KTB][1]>1){
		for(s=0;s<tnk[KTB][7];s++){
			arr_dtout[cn]=arr_d[arr_cn][(tnk[KTB][2]-tnk[KTB][3]-1)+1];cn++;arr_cn++;
		}
	}
for(var d=(tnk[KTB][2]-tnk[KTB][3]-1);d>=0;d--){
	arr_cn=0;
	for(s=0;s<tnk[KTB][4];s++){
		arr_dtout[cn]=arr_drt[arr_cn][d];cn++;arr_cn++;
	}
	if(tnk[KTB][1]>1){
		for(s=0;s<tnk[KTB][7];s++){
			arr_dtout[cn]=arr_drt[arr_cn][d];cn++;arr_cn++;
		}
	}
}
////////位置検出パターン////////
//位置検出パターン：左上
for(var j=0; j<=6; j++){
	for(var i=0; i<=6; i++){
		if(j==0 || j==6 || i==0 || i==6 || ((i>=2 && i<=4)&&(j>=2 && j<=4))){
		arr1[j][i] = 1;
		}
	}
}
//位置検出パターン：右上
xi = SZ-7;
for(var j=0; j<=6; j++){
	for(var i=0+xi; i<=6+xi; i++){
		if(j==0 || j==6 || i==0+xi || i==6+xi || ((i>=2+xi && i<=4+xi)&&(j>=2 && j<=4))){
		arr1[j][i] = 1;
		}
	}
}
//位置検出パターン：左下
yj = SZ-7;
for(var j=0+yj; j<=6+yj; j++){
	for(var i=0; i<=6; i++){
		if(j==0+yj || j==6+yj || i==0 || i==6 || ((i>=2 && i<=4)&&(j>=2+yj && j<=4+yj))){
		arr1[j][i] = 1;
		}
	}
}





////////位置検出パターン////////
//形式情報を格納-----//

/*
///// 一例
11 //訂正レベルQ
   011 //マスクパターン　(i+j) mod 3 == 0
       1000010100 // 剰余計算結果
11 011 1000010100
10 101 0000010010 //XOR固定値
01 110 1000000110 //最終形
*/

var keisiki_jouyo;
// 各マスクごとの、剰余計算結果 (訂正レベルQ=11で固定)
/*
000 => 0101001101
001 => 0001111010
010 => 1100100011
011 => 1000010100
100 => 0010100110
101 => 0110010001
110 => 1011001000
111 => 1111111111
*/
	switch (mask_ptn){
	case '000':
		keisiki_jouyo = '0101001101';
		break;
	case '001':
		keisiki_jouyo = '0001111010';
		break;
	case '010':
		keisiki_jouyo = '1100100011';
		break;
	case '011':
		keisiki_jouyo = '1000010100';
		break;
	case '100':
		keisiki_jouyo = '0010100110';
		break;
	case '101':
		keisiki_jouyo = '0110010001';
		break;
	case '110':
		keisiki_jouyo = '1011001000';
		break;
	case '111':
		keisiki_jouyo = '1111111111';
		break;
	default:
		break;
	}


var SZr = SZ-1;
keishiki_i = [0,1,2,3,4,5,7,8, 8,8,8,8,8,8,8, 8,8,8,8,8,8,8,       SZr-7,SZr-6,SZr-5,SZr-4,SZr-3,SZr-2,SZr-1,SZr+0];
keishiki_j = [8,8,8,8,8,8,8,8, 7,5,4,3,2,1,1, SZr+0,SZr-1,SZr-2,SZr-3,SZr-4,SZr-5,SZr-6, 8,8,8,8,8,8,8,8];

//var keisiki = "011101000000110";
var keisiki = "";

keisiki = get_xor("11" + mask_ptn + keisiki_jouyo,"101010000010010")

for(var d=0;d<15;d++){
	arr1[keishiki_j[d]][keishiki_i[d]] = keisiki[d];
	arr1[keishiki_j[d+15]][keishiki_i[d+15]] = keisiki[d];
}
arr1[SZr-7][8] = 1;
//形式情報を格納-----//
//arr_notdata
for(j=0;j<SZ;j+=1){
	for(i=0;i<SZ;i+=1){
		//位置検出パターンと、タイミングパターン
		if((j<=8 && i<=8) || 
		   (i>=SZ-8 && j<=8) ||
		   (j>=SZ-8 && i<=8) ||
		   (i==6) ||
		   (j==6)
		 ){
		arr_notdata[j][i] = 1;
		}
		//タイミングパターン模様塗り//xx/
		if(
		   (j==6 && i>=8 && i<=SZ-8 && (i%2==0)) ||
		   (i==6 && j>=8 && j<=SZ-8 && (j%2==0)) 
		 ){
			arr1[j][i] = 1;
		}
		//7型以上の型番情報
		if((SZ>=45) && 
			(
		   (i<6 && j<=SZ-8-1 && j>=SZ-8-3) ||
		   (j<6 && i<=SZ-8-1 && i>=SZ-8-3)
			)
		 ){
		arr_notdata[j][i] = 1;
		}
	}
}
//「7型以上の型番情報」を格納-----//
if(KTB>=7){
	cn =ktbmx.length-1;
	for(var j=0;j<6;j++){
		for(var i=SZ-8-3;i<=SZ-8-1;i++){
			//alert(ktb[cn]);
			arr1[j][i] = ktbmx[cn];cn--;
		}
	}
	cn =ktbmx.length-1;
	for(var i=0;i<6;i++){
		for(var j=SZ-8-3;j<=SZ-8-1;j++){
			arr1[j][i] = ktbmx[cn];cn--;
		}
	}
}
//「7型以上の型番情報」を格納-----//
//位置合わせパターンをマスク（ここでのマスクは、隠す意味だけ）
for(j=0;j<SZ;j+=1){ //*1
	for(i=0;i<SZ;i+=1){ //*2
for( var ii=0; ii<arr_ichi.length; ii++) { //*3
	for( var jj=0; jj<arr_ichi.length; jj++) { //*4
	
	if((ii==0&&jj==0)||(ii==0&&jj==arr_ichi.length-1)||(ii==arr_ichi.length-1&&jj==0)){
	}else{
		ichi_i = arr_ichi[ii] ;
		ichi_j = arr_ichi[jj] ;
			if(
			((j>=ichi_j-1-2 && j<=ichi_j-1+2) &&
			 (i>=ichi_i-1-2 && i<=ichi_i-1+2)) 
			 ){
				arr_notdata[j][i] = 1;
				//位置合わせパターンの模様塗り//xx/
				arr1[j][i] = 1;
				if(
				((j>=ichi_j-1-1 && j<=ichi_j-1+1) &&
				 (i>=ichi_i-1-1 && i<=ichi_i-1+1)) 
				 ){
					arr1[j][i] = 0;
					if(j==ichi_j-1 && i==ichi_i-1){
						arr1[j][i] = 1;
					}
				}//xx/
			}
	}
	} //*4
} //*3
	} //*2
} //*1
var datasu; 
if(tnk[KTB][1]>1){
	datasu = tnk[KTB][2]*tnk[KTB][4]+tnk[KTB][5]*tnk[KTB][7];
}else{
	datasu = tnk[KTB][2]*tnk[KTB][4];
}
var cn = 0;
var arr_dtout_b8 = [];
//for(var d=0;d<(33+33+34+34);d++){
for(var d=0;d<(datasu);d++){
	var dd = b8(arr_dtout[d]);
	for(var dc=0;dc<8;dc++){
		arr_dtout_b8[cn] = dd.substr(dc,1);
		cn++;
	}
}
cn = 0;
var cnt = 1;
//データ欄に、順番を入れていく
for(i=SZ-1;i>=0;i-=2){
	if(i == 6){i-=1;}
	for(j=SZ-1;j>=0;j-=1){
		if(arr_notdata[j][i] ==0
		 ){
		arr_data[j][i] = arr_dtout_b8[cn];cn++;// //cnt;
		cnt ++;
		}
		if(arr_notdata[j][i-1] ==0
		 ){
		arr_data[j][i-1] = arr_dtout_b8[cn];cn++;// //cnt;
		cnt ++;
		}
	}
	i-=2;
	if(i == 6){i-=1;}
	for(j=0;j<SZ;j+=1){
		if(arr_notdata[j][i] ==0
		 ){
		arr_data[j][i] = arr_dtout_b8[cn];cn++;// //cnt;
		cnt ++;
		}
		if(arr_notdata[j][i-1] ==0
		 ){
		arr_data[j][i-1] = arr_dtout_b8[cn];cn++;// //cnt;
		cnt ++;
		}
	}
}

////規格では、横方向がjで、縦方向がiだが
////このソースでは横方向がiで、縦方向がj（スマン
for(j=0;j<SZ;j+=1){
	for(i=0;i<SZ;i+=1){
		
		/*
		//NOT data欄の確認
		if(arr_notdata[j][i]=='1'){
			ctx[c].fillStyle = '#FF0';
			ctx[c].fillRect(30+i*rd, 30+j*rd, rd-mgn, rd-mgn);
		}else{
		}
		*/
		
		//３か所の位置検出パターンの配置
		if(arr1[j][i]=='1'){
			ctx[c].fillStyle = '#000';			
			ctx[c].fillRect(30+i*rd, 30+j*rd, rd-mgn, rd-mgn);
		}else{
		}
		
		//----------------------------------
		//マスクの適用。data欄のみ。上書きしてしまっている
		//マスクパタンによる判定は、関数mask_ptn_hanteiへ
		if(  (mask_ptn_hantei(mask_ptn,i,j)) && arr_notdata[j][i]!='1'){
			arr_data[j][i] = arr_data[j][i]^1;
		}



		//data欄の確認
		if(arr_data[j][i]=='1'){
			ctx[c].fillStyle = 'black';
			ctx[c].fillRect(30+i*rd, 30+j*rd, rd-mgn, rd-mgn);
		}else{
		}




	}
}


}////rnst c

}//main();


</script>

</body>
</html>